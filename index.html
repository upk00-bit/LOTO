<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loto Online 9x9</title>
    <style>
        /* --- CSS STYLES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; font-size: 16px; transition: 0.3s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn:hover { opacity: 0.9; }
        
        /* Login & Lobby */
        #login-screen, #lobby-screen { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input { width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }

        /* Game Layout */
        #game-screen { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* Left Panel: Info & Board */
        .left-panel { flex: 1; min-width: 300px; text-align: left; }
        .current-number { font-size: 80px; font-weight: bold; color: #d63384; text-align: center; background: #fff; border-radius: 10px; margin-bottom: 20px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .history-board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; background: white; padding: 10px; border-radius: 5px; }
        .history-num { font-size: 12px; padding: 5px; text-align: center; border: 1px solid #eee; color: #ccc; }
        .history-num.active { background-color: #007bff; color: white; font-weight: bold; }

        /* Center Panel: Ticket */
        .ticket-panel { flex: 2; min-width: 340px; }
        .ticket { border: 2px solid #333; background: white; padding: 5px; border-radius: 5px; user-select: none; }
        .ticket-row { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; margin-bottom: 2px; padding: 5px; border-radius: 4px; transition: background 0.3s; }
        
        /* Highlight Logic */
        .ticket-row.highlight-red { background-color: #ffcccc; /* ƒê·ªè nh·∫°t khi ƒë·ªß 4 s·ªë */ }
        .ticket-row.highlight-gold { background-color: #ffd700; animation: blink 1s infinite; /* V√†ng khi ƒë·ªß 5 s·ªë */ }

        .cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; font-weight: bold; font-size: 18px; cursor: pointer; background: #fff; }
        .cell.empty { background: #f9f9f9; cursor: default; }
        .cell.marked { background-color: #28a745; color: white; border-color: #28a745; }

        /* Chat */
        .chat-panel { flex: 1; min-width: 250px; background: white; border-radius: 10px; padding: 10px; height: 500px; display: flex; flex-direction: column; }
        #chat-messages { flex: 1; overflow-y: auto; border-bottom: 1px solid #eee; margin-bottom: 10px; text-align: left; padding: 5px; }
        .msg { margin-bottom: 5px; font-size: 14px; }
        .msg strong { color: #007bff; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Loto Online</h2>
        <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
        <div>
            <button class="btn btn-primary" onclick="login('host')">T·∫°o Ph√≤ng (Host)</button>
            <button class="btn btn-success" onclick="login('player')">Tham Gia (Player)</button>
        </div>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3>Ch√†o, <span id="display-name"></span></h3>
        <div id="host-controls" class="hidden">
            <p>M√£ ph√≤ng c·ªßa b·∫°n: <strong style="font-size: 24px; color: red;">1234</strong></p>
            <p>ƒêang ch·ªù ng∆∞·ªùi ch∆°i...</p>
            <button class="btn btn-primary" onclick="startGame()">B·∫Øt ƒë·∫ßu v√°n m·ªõi</button>
        </div>
        <div id="player-controls" class="hidden">
            <input type="text" id="room-id" placeholder="Nh·∫≠p m√£ ph√≤ng (VD: 1234)">
            <button class="btn btn-success" onclick="joinRoom()">V√†o ph√≤ng</button>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="left-panel">
            <div style="margin-bottom: 5px;">S·ªë v·ª´a g·ªçi:</div>
            <div class="current-number" id="current-number">--</div>
            
            <div id="game-host-controls" class="hidden" style="margin-bottom: 15px; text-align: center;">
                <button class="btn btn-danger" onclick="drawNumber()">üî¥ B·ªëc S·ªë</button>
                <button class="btn btn-success" onclick="checkWinner()">üèÜ Ki·ªÉm tra Kinh</button>
                <br><br>
                <button class="btn btn-primary" onclick="resetGame()">üîÑ V√°n m·ªõi (Gi·ªØ v√©)</button>
            </div>

            <div style="margin-bottom: 5px;">L·ªãch s·ª≠ s·ªë:</div>
            <div class="history-board" id="history-board">
                </div>
        </div>

        <div class="ticket-panel">
            <h3>V√© D√≤ S·ªë (ID: <span id="ticket-id">#01</span>)</h3>
            <div class="ticket" id="my-ticket">
                </div>
        </div>

        <div class="chat-panel">
            <h4>K√™nh Chat</h4>
            <div id="chat-messages"></div>
            <div style="display: flex;">
                <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." style="margin-bottom: 0;">
                <button class="btn btn-primary" onclick="sendMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH & TR·∫†NG TH√ÅI GAME ---
        let role = ''; // 'host' ho·∫∑c 'player'
        let currentUser = '';
        let currentTicket = []; // L∆∞u c·∫•u tr√∫c v√© c·ªßa ng∆∞·ªùi ch∆°i
        let calledNumbers = []; // Danh s√°ch s·ªë ƒë√£ g·ªçi
        let isGameActive = false;

        // --- 1. H·ªÜ TH·ªêNG LOGIC V√â S·ªê (Ticket System) ---
        
        function generateTicketData() {
            // T·∫°o v√© 9 h√†ng, m·ªói h√†ng 9 c·ªôt
            // Quy t·∫Øc: C·ªôt 1 (1-9), C·ªôt 2 (10-19)... C·ªôt 9 (80-90)
            // M·ªói h√†ng ch·ªâ ƒë∆∞·ª£c c√≥ 5 s·ªë, 4 √¥ tr·ªëng.
            let ticket = [];
            for (let r = 0; r < 9; r++) {
                let row = new Array(9).fill(null); // M·∫£ng r·ªóng
                let indices = [];
                
                // Ch·ªçn ng·∫´u nhi√™n 5 v·ªã tr√≠ c·ªôt ƒë·ªÉ ƒëi·ªÅn s·ªë
                while (indices.length < 5) {
                    let idx = Math.floor(Math.random() * 9);
                    if (!indices.includes(idx)) indices.push(idx);
                }
                indices.sort((a, b) => a - b);

                // ƒêi·ªÅn s·ªë v√†o c√°c v·ªã tr√≠ ƒë√£ ch·ªçn
                indices.forEach(colIndex => {
                    let min = colIndex * 10;
                    let max = (colIndex * 10) + 9;
                    if (colIndex === 0) min = 1; // C·ªôt 1 t·ª´ 1-9
                    if (colIndex === 8) max = 90; // C·ªôt 9 t·ª´ 80-90

                    // Random s·ªë trong kho·∫£ng, tr√°nh tr√πng l·∫∑p trong c√πng 1 c·ªôt (n√¢ng cao c·∫ßn check to√†n v√©)
                    // ·ªû ƒë√¢y l√†m ƒë∆°n gi·∫£n: random
                    let num = Math.floor(Math.random() * (max - min + 1)) + min;
                    row[colIndex] = num;
                });
                ticket.push(row);
            }
            return ticket;
        }

        // --- 2. GIAO DI·ªÜN & T∆Ø∆†NG T√ÅC (UI) ---

        function renderHistoryBoard() {
            const board = document.getElementById('history-board');
            board.innerHTML = '';
            for (let i = 1; i <= 90; i++) {
                const div = document.createElement('div');
                div.className = 'history-num';
                div.id = `hist-${i}`;
                div.innerText = i;
                board.appendChild(div);
            }
        }

        function renderTicket(ticketData) {
            const container = document.getElementById('my-ticket');
            container.innerHTML = '';
            
            ticketData.forEach((row, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'ticket-row';
                rowDiv.id = `row-${rowIndex}`;

                row.forEach((num) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (num === null) {
                        cell.classList.add('empty');
                    } else {
                        cell.innerText = num;
                        cell.dataset.value = num; // L∆∞u gi√° tr·ªã ƒë·ªÉ check
                        cell.onclick = function() { toggleMark(this, rowIndex); };
                    }
                    rowDiv.appendChild(cell);
                });
                container.appendChild(rowDiv);
            });
        }

        // Logic ƒë√°nh d·∫•u s·ªë (Click v√†o v√©)
        function toggleMark(cell, rowIndex) {
            if (!isGameActive) return; // Ch·ªâ cho ƒë√°nh d·∫•u khi game ƒëang ch·∫°y
            if (cell.classList.contains('empty')) return;
            
            // Toggle class
            cell.classList.toggle('marked');

            // SAU KHI CLICK -> KI·ªÇM TRA H√ÄNG ƒê·ªÇ HIGHLIGHT (AUTO SCAN)
            scanRow(rowIndex);
        }

        // --- 3. LOGIC QU√âT V√â T·ª∞ ƒê·ªòNG (Auto Scan Feature) ---
        function scanRow(rowIndex) {
            const rowEl = document.getElementById(`row-${rowIndex}`);
            const markedCells = rowEl.querySelectorAll('.cell.marked').length;

            // X√≥a highlight c≈©
            rowEl.classList.remove('highlight-red', 'highlight-gold');

            if (markedCells === 4) {
                rowEl.classList.add('highlight-red'); // ƒê·ªè nh·∫°t: S·∫Øp th·∫Øng
            } else if (markedCells === 5) {
                rowEl.classList.add('highlight-gold'); // V√†ng: ƒê√£ Kinh (Th·∫Øng)
                // T·ª± ƒë·ªông b√°o v·ªÅ Host (Trong th·ª±c t·∫ø c·∫ßn g·ª≠i socket)
                addChatMessage("H·ªá th·ªëng", `H√†ng s·ªë ${rowIndex + 1} ƒë√£ ƒë·ªß 5 s·ªë! KINH!`);
                alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ KINH (ƒê·ªß 5 s·ªë)!");
            }
        }

        // --- 4. CH·ª®C NƒÇNG HOST & GAME FLOW ---

        function drawNumber() {
            if (calledNumbers.length >= 90) return;
            
            let num;
            do {
                num = Math.floor(Math.random() * 90) + 1;
            } while (calledNumbers.includes(num));

            calledNumbers.push(num);
            updateGameState(num);
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã (M√¥ ph·ªèng realtime)
        function updateGameState(newNum) {
            // 1. Hi·ªán s·ªë to
            document.getElementById('current-number').innerText = newNum;
            
            // 2. S√°ng l·ªãch s·ª≠
            const histEl = document.getElementById(`hist-${newNum}`);
            if (histEl) histEl.classList.add('active');

            // 3. T·ª∞ ƒê·ªòNG QU√âT V√â NG∆Ø·ªúI CH∆†I (H·ªá th·ªëng h·ªó tr·ª£ d√≤)
            // T√¨m s·ªë tr√™n v√© ng∆∞·ªùi ch∆°i, n·∫øu c√≥ th√¨ t·ª± ƒë·ªông b√°o (ho·∫∑c ch·ªù ng∆∞·ªùi ch∆°i click t√πy lu·∫≠t)
            // ·ªû ƒë√¢y ta gi·ªØ nguy√™n vi·ªác ng∆∞·ªùi ch∆°i ph·∫£i t·ª± click, nh∆∞ng h·ªá th·ªëng s·∫Ω h·ªó tr·ª£ highlight n·∫øu h·ªç click ƒë√∫ng.
        }

        function checkWinner() {
            alert("Host ƒëang ki·ªÉm tra v√© c·ªßa ng∆∞·ªùi b√°o th·∫Øng...");
            // Logic so kh·ªõp v√© ng∆∞·ªùi th·∫Øng v·ªõi calledNumbers
        }

        // --- 5. LOGIC RESET (FIX BUG THEO Y√äU C·∫¶U) ---
        // "Sau v√°n ch∆°i, t√¥i v·∫´n gi·ªØ v√© c≈©... b·∫Øt ƒë·∫ßu v√°n m·ªõi √¥ t√¥ m√†u tr·ªü l·∫°i b√¨nh th∆∞·ªùng"
        function resetGame() {
            if(!confirm("B·∫Øt ƒë·∫ßu v√°n m·ªõi? V√© c·ªßa ng∆∞·ªùi ch∆°i s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n, ch·ªâ x√≥a c√°c √¥ ƒë√£ t√¥.")) return;

            // Reset d·ªØ li·ªáu game
            calledNumbers = [];
            document.getElementById('current-number').innerText = "--";
            
            // Reset B·∫£ng L·ªãch S·ª≠
            document.querySelectorAll('.history-num').forEach(el => el.classList.remove('active'));

            // QUAN TR·ªåNG: Reset V√© (Gi·ªØ s·ªë, x√≥a m√†u)
            // L·∫•y t·∫•t c·∫£ c√°c √¥ ƒëang marked, b·ªè marked ƒëi
            document.querySelectorAll('.cell.marked').forEach(el => el.classList.remove('marked'));
            
            // X√≥a highlight h√†ng (ƒë·ªè/v√†ng)
            document.querySelectorAll('.ticket-row').forEach(el => {
                el.classList.remove('highlight-red', 'highlight-gold');
            });

            isGameActive = true;
            addChatMessage("H·ªá th·ªëng", "--- V√ÅN M·ªöI B·∫ÆT ƒê·∫¶U ---");
        }

        // --- NAVIGATION & CHAT ---
        
        function login(userRole) {
            const name = document.getElementById('username').value;
            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            
            currentUser = name;
            role = userRole;
            document.getElementById('display-name').innerText = currentUser;

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');

            if (role === 'host') {
                document.getElementById('host-controls').classList.remove('hidden');
            } else {
                document.getElementById('player-controls').classList.remove('hidden');
            }
        }

        function joinRoom() {
            const roomId = document.getElementById('room-id').value;
            if (roomId !== '1234') return alert("Ph√≤ng kh√¥ng t·ªìn t·∫°i! (Th·ª≠ 1234)");
            startGame();
        }

        function startGame() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            renderHistoryBoard();
            
            // Sinh v√© cho ng∆∞·ªùi ch∆°i (Ho·∫∑c Host c≈©ng c√≥ v√© ƒë·ªÉ ch∆°i c√πng)
            currentTicket = generateTicketData();
            renderTicket(currentTicket);

            if (role === 'host') {
                document.getElementById('game-host-controls').classList.remove('hidden');
                isGameActive = true;
            } else {
                // Player ch·ªù Host b·∫Øt ƒë·∫ßu
                isGameActive = true; // Demo th√¨ cho true lu√¥n
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (msg) {
                addChatMessage(currentUser, msg);
                input.value = '';
            }
        }

        function addChatMessage(user, text) {
            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div class="msg"><strong>${user}:</strong> ${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
